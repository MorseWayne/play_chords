# Soundfont ç³»ç»Ÿé‡æ„è¯´æ˜

## æ”¹è¿›æ¦‚è¿°

æˆ‘ä»¬å·²ç»å°†æ—§çš„ soundfont-player åº“æ›¿æ¢ä¸ºç°ä»£çš„ Web Audio API å®ç°ï¼Œå¸¦æ¥ä»¥ä¸‹æ”¹è¿›ï¼š

### âœ… å·²å®Œæˆçš„æ”¹è¿›

1. **ç‹¬ç«‹éŸ³é¢‘æ–‡ä»¶**
   - å°†åŸæ¥çš„å•ä¸ª 400KB+ JS æ–‡ä»¶æ‹†åˆ†ä¸º 88 ä¸ªç‹¬ç«‹çš„ MP3 æ–‡ä»¶
   - æ¯ä¸ªéŸ³ç¬¦å¹³å‡çº¦ 16KB
   - æ€»å¤§å°çº¦ 1.4MBï¼ˆæœªå‹ç¼©ï¼‰

2. **æŒ‰éœ€åŠ è½½**
   - éŸ³ç¬¦æ–‡ä»¶æŒ‰éœ€å¼‚æ­¥åŠ è½½
   - å‡å°‘åˆå§‹åŠ è½½æ—¶é—´
   - æ›´å¥½çš„å†…å­˜ç®¡ç†

3. **æ™ºèƒ½é¢„åŠ è½½**
   - è‡ªåŠ¨é¢„åŠ è½½å‰ä»–å¸¸ç”¨éŸ³åŸŸï¼ˆE2-E5ï¼‰
   - æ ¹æ®å’Œå¼¦æ™ºèƒ½é¢„æµ‹ç›¸é‚»éŸ³ç¬¦
   - è®°å½•æœ€è¿‘ä½¿ç”¨çš„éŸ³ç¬¦ï¼Œä¼˜å…ˆåŠ è½½

4. **ç°ä»£æ¶æ„**
   - ä½¿ç”¨ TypeScript ç±»å‹å®‰å…¨
   - æ¸…æ™°çš„æ¨¡å—åŒ–è®¾è®¡
   - æ›´å¥½çš„é”™è¯¯å¤„ç†

### ğŸ“ æ–‡ä»¶ç»“æ„

```
src/lib/soundfont/
â”œâ”€â”€ ModernSoundfontLoader.ts  # æ ¸å¿ƒåŠ è½½å™¨
â”œâ”€â”€ SmartPreloader.ts          # æ™ºèƒ½é¢„åŠ è½½ç®¡ç†
â””â”€â”€ index.ts                   # å¯¼å‡ºå…¥å£

public/soundfonts/guitar/
â”œâ”€â”€ manifest.json              # éŸ³ç¬¦åˆ—è¡¨é…ç½®
â”œâ”€â”€ A0.mp3                     # ç‹¬ç«‹éŸ³é¢‘æ–‡ä»¶
â”œâ”€â”€ Bb0.mp3
â”œâ”€â”€ ...
â””â”€â”€ C8.mp3                     # å…± 88 ä¸ªæ–‡ä»¶

scripts/
â””â”€â”€ extract-soundfont.js       # æå–å·¥å…·è„šæœ¬
```

### ğŸ¯ API ä½¿ç”¨ç¤ºä¾‹

```typescript
import { ModernSoundfontLoader, SmartPreloader } from '@/lib/soundfont';

// åˆ›å»ºåŠ è½½å™¨
const audioContext = new AudioContext();
const loader = new ModernSoundfontLoader(audioContext, '/soundfonts/guitar');

// åŠ è½½å¹¶æ’­æ”¾
await loader.preloadGuitarRange();
loader.playStrum(['E2', 'A2', 'D3', 'G3', 'B3', 'E4']);

// ä½¿ç”¨æ™ºèƒ½é¢„åŠ è½½
const preloader = new SmartPreloader(loader);
await preloader.preloadForMidiNotes([64, 67, 71]); // E4, G4, B4
```

### ğŸ”§ é…ç½®

åœ¨ `AudioContext.tsx` ä¸­ï¼ŒbasePath ä¼šæ ¹æ®ç¯å¢ƒè‡ªåŠ¨é…ç½®ï¼š
- å¼€å‘ç¯å¢ƒï¼š`/soundfonts/guitar`
- ç”Ÿäº§ç¯å¢ƒï¼š`/play_chords/soundfonts/guitar`

### ğŸ“Š æ€§èƒ½å¯¹æ¯”

**æ—§å®ç°ï¼ˆsoundfont-playerï¼‰ï¼š**
- åˆå§‹åŠ è½½ï¼š~400KBï¼ˆä¸€æ¬¡æ€§åŠ è½½æ‰€æœ‰éŸ³ç¬¦ï¼‰
- å†…å­˜å ç”¨ï¼šé«˜ï¼ˆæ‰€æœ‰éŸ³ç¬¦å¸¸é©»å†…å­˜ï¼‰
- çµæ´»æ€§ï¼šä½ï¼ˆéš¾ä»¥ä¼˜åŒ–å’Œæ‰©å±•ï¼‰

**æ–°å®ç°ï¼ˆModern Loaderï¼‰ï¼š**
- åˆå§‹åŠ è½½ï¼š~600KBï¼ˆåªåŠ è½½å¸¸ç”¨éŸ³åŸŸ 37 ä¸ªéŸ³ç¬¦ï¼‰
- å†…å­˜å ç”¨ï¼šä½ï¼ˆæŒ‰éœ€åŠ è½½ï¼Œå¯é‡Šæ”¾ï¼‰
- çµæ´»æ€§ï¼šé«˜ï¼ˆæ˜“äºä¼˜åŒ–å’Œæ‰©å±•ï¼‰
- é¦–æ¬¡æ’­æ”¾å»¶è¿Ÿï¼š<100msï¼ˆå·²é¢„åŠ è½½çš„éŸ³ç¬¦ï¼‰

### ğŸš€ æœªæ¥å¯èƒ½çš„ä¼˜åŒ–

1. **Service Worker ç¼“å­˜**
   - ç¦»çº¿æ”¯æŒ
   - æ›´å¿«çš„äºŒæ¬¡åŠ è½½

2. **WebP/Opus æ ¼å¼**
   - æ›´å°çš„æ–‡ä»¶ä½“ç§¯
   - æ›´å¥½çš„éŸ³è´¨

3. **CDN åˆ†å‘**
   - å…¨çƒåŠ é€Ÿ
   - å‡è½»æœåŠ¡å™¨è´Ÿè½½

4. **åŠ¨æ€å‹ç¼©**
   - Gzip/Brotli å‹ç¼©
   - å¯å‡å°‘ 60-70% ä½“ç§¯

### ğŸ“ è¿ç§»è¯´æ˜

AudioContext çš„ API ä¿æŒä¸å˜ï¼Œç°æœ‰ä»£ç æ— éœ€ä¿®æ”¹ï¼š
- `playStrum(midiNotes)` - æ’­æ”¾æ‰«å¼¦
- `playArpeggio(midiNotes)` - æ’­æ”¾ç¶éŸ³
- `initAudio()` - åˆå§‹åŒ–éŸ³é¢‘
- `updateVolume(volume)` - æ›´æ–°éŸ³é‡

### ğŸ§ª æµ‹è¯•

æ„å»ºå¹¶æµ‹è¯•ï¼š
```bash
npm run build
npm run dev
```

è®¿é—®åº”ç”¨å¹¶æµ‹è¯•ï¼š
1. ç‚¹å‡»"åŠ è½½éŸ³è‰²"æŒ‰é’®
2. é€‰æ‹©å’Œå¼¦å¹¶æ’­æ”¾
3. æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°çš„åŠ è½½æ—¥å¿—
4. æ£€æŸ¥ç½‘ç»œé¢æ¿çš„éŸ³é¢‘æ–‡ä»¶åŠ è½½

### ğŸ—‘ï¸ æ¸…ç†æ—§æ–‡ä»¶

æ–°å®ç°ç¨³å®šåå¯ä»¥åˆ é™¤ï¼š
- `public/soundfonts/MusyngKite/acoustic_guitar_steel-mp3.js`
- `node_modules/soundfont-player`ï¼ˆå¦‚æœæ²¡æœ‰å…¶ä»–åœ°æ–¹ä½¿ç”¨ï¼‰

å¯ä»¥åœ¨ `package.json` ä¸­ç§»é™¤ï¼š
```json
"soundfont-player": "^0.12.0"
```
