# Spec Delta: progression-practice

## ADDED Requirements

### Requirement: 扩展预置走向库

系统 SHALL 提供至少 20 个预置和弦走向，覆盖流行、爵士、布鲁斯、民谣、拉丁等风格。

#### Scenario: 查看预置走向列表
- **WHEN** 用户打开和弦走向练习页面
- **THEN** 系统显示至少 20 个预置走向
- **AND** 每个走向包含名称、罗马数字序列、标签（tags）、说明（notes）、推荐 BPM

#### Scenario: 按分类浏览走向
- **WHEN** 用户查看走向库
- **THEN** 走向按风格分类（流行、爵士、布鲁斯、民谣、拉丁、自定义）
- **AND** 用户可以按分类筛选或浏览

#### Scenario: 走向元数据完整
- **WHEN** 用户选择任一预置走向
- **THEN** 系统显示走向的完整信息
- **AND** 包括：名称、罗马数字、标签、说明、推荐 BPM、适用风格

### Requirement: 自定义和弦走向

系统 SHALL 允许用户创建、编辑、删除自定义和弦走向。

#### Scenario: 创建自定义走向（罗马数字模式）
- **WHEN** 用户点击"添加自定义走向"
- **AND** 选择"罗马数字模式"
- **AND** 输入罗马数字序列（如 `I vi IV V` 或 `ii7 V7 Imaj7`）
- **AND** 输入走向名称
- **THEN** 系统解析罗马数字并生成走向
- **AND** 保存到本地存储
- **AND** 添加到走向库列表

#### Scenario: 创建自定义走向（和弦名称模式）
- **WHEN** 用户点击"添加自定义走向"
- **AND** 选择"和弦名称模式"
- **AND** 输入和弦名称序列（如 `C Am F G` 或 `Dm7 G7 Cmaj7`）
- **AND** 输入走向名称
- **THEN** 系统解析和弦名称并生成走向
- **AND** 保存到本地存储
- **AND** 添加到走向库列表

#### Scenario: 输入验证与错误提示
- **WHEN** 用户输入无效的罗马数字或和弦名称
- **THEN** 系统显示具体的错误提示
- **AND** 提供输入建议或示例
- **AND** 不允许保存无效的走向

#### Scenario: 编辑已保存的自定义走向
- **WHEN** 用户选择一个自定义走向
- **AND** 点击"编辑"
- **THEN** 系统打开编辑对话框
- **AND** 显示当前的走向定义
- **AND** 允许修改名称、罗马数字/和弦名称、标签等
- **AND** 保存后更新本地存储

#### Scenario: 删除自定义走向
- **WHEN** 用户选择一个自定义走向
- **AND** 点击"删除"
- **THEN** 系统显示确认对话框
- **AND** 确认后从本地存储删除
- **AND** 从走向库列表移除

#### Scenario: 自定义走向持久化
- **WHEN** 用户创建或编辑自定义走向
- **AND** 刷新页面或重新打开应用
- **THEN** 所有自定义走向仍然存在
- **AND** 保持与创建时相同的内容

#### Scenario: 自定义走向与预置走向功能一致
- **WHEN** 用户选择一个自定义走向进行练习
- **THEN** 系统提供与预置走向相同的所有功能
- **AND** 包括：调性切换、BPM 调整、循环、播放控制、练习模式等

### Requirement: 和弦把位选择

系统 SHALL 允许用户为走向中的每个和弦手动选择把位（voicing）。

#### Scenario: 查看可用把位列表
- **WHEN** 用户练习某个走向
- **AND** 查看当前和弦
- **THEN** 系统显示该和弦的所有可用把位
- **AND** 按品位范围分组显示（如 0-4品、5-8品、9-12品）
- **AND** 高亮当前选中的把位

#### Scenario: 切换和弦把位
- **WHEN** 用户点击某个把位选项
- **THEN** 系统立即更新指法图显示
- **AND** 播放该把位的和弦音频（自动试听）
- **AND** 记住该选择

#### Scenario: 把位偏好持久化
- **WHEN** 用户为走向中的各个和弦选择把位
- **AND** 刷新页面或切换到其他走向后返回
- **THEN** 系统自动加载之前选择的把位
- **AND** 显示相同的指法图

#### Scenario: 不同走向的把位独立记忆
- **WHEN** 用户为走向 A 选择一组把位
- **AND** 切换到走向 B 选择另一组把位
- **AND** 再次切换回走向 A
- **THEN** 系统加载走向 A 之前的把位设置
- **AND** 不受走向 B 的影响

#### Scenario: 走向预览显示把位信息
- **WHEN** 用户查看走向预览（所有和弦的列表）
- **THEN** 每个和弦卡片显示当前选中的把位信息
- **AND** 例如："C (5品)" 或 "Am (开放把位)"
- **AND** 用户可以快速点击切换把位

#### Scenario: 键盘快捷键切换把位
- **WHEN** 用户在练习过程中
- **AND** 按下特定键盘快捷键（如 `[` 或 `]`）
- **THEN** 系统切换到上一个或下一个可用把位
- **AND** 立即更新显示与音频

### Requirement: 数据持久化与状态管理

系统 SHALL 使用 LocalStorage 持久化自定义走向和把位偏好设置。

#### Scenario: 自定义走向存储
- **WHEN** 用户创建或编辑自定义走向
- **THEN** 系统将数据保存到 LocalStorage key `custom-progressions`
- **AND** 数据格式为 JSON 数组

#### Scenario: 把位偏好存储
- **WHEN** 用户为某个走向的和弦选择把位
- **THEN** 系统将偏好保存到 LocalStorage key `progression-voicing-preferences`
- **AND** 数据格式为 `{ progressionId: { chordIndex: voicingIndex } }`

#### Scenario: 存储容量处理
- **WHEN** LocalStorage 空间不足（quota exceeded）
- **THEN** 系统显示友好的错误提示
- **AND** 提示用户清理旧数据或使用浏览器清理工具

#### Scenario: 数据解析错误处理
- **WHEN** LocalStorage 中的数据格式损坏或无效
- **THEN** 系统使用默认值或空数据
- **AND** 不阻塞应用加载
- **AND** 记录错误日志（如有日志系统）

### Requirement: 罗马数字与和弦名称解析

系统 SHALL 提供准确的罗马数字和和弦名称解析功能。

#### Scenario: 解析基础罗马数字
- **WHEN** 系统解析输入 `I V vi IV`
- **THEN** 识别为 4 个和弦
- **AND** I 为大三和弦，V 为大三和弦，vi 为小三和弦，IV 为大三和弦
- **AND** 根据调性生成具体和弦名称

#### Scenario: 解析七和弦罗马数字
- **WHEN** 系统解析输入 `ii7 V7 Imaj7`
- **THEN** 识别为 3 个和弦
- **AND** ii7 为小七和弦，V7 为属七和弦，Imaj7 为大七和弦

#### Scenario: 解析和弦名称（绝对音高）
- **WHEN** 系统解析输入 `C Am F G`
- **THEN** 识别为 4 个和弦
- **AND** C 为 C 大三和弦，Am 为 A 小三和弦，F 为 F 大三和弦，G 为 G 大三和弦
- **AND** 自动推断调性为 C 大调

#### Scenario: 解析复杂和弦名称
- **WHEN** 系统解析输入 `Dm7 G7 Cmaj7 Am7`
- **THEN** 识别为 4 个和弦
- **AND** 正确识别所有七和弦类型

#### Scenario: 处理异常输入
- **WHEN** 用户输入不合法的罗马数字或和弦名称（如 `X` 或 `Z123`）
- **THEN** 系统返回具体的错误信息
- **AND** 指出哪个符号无法识别
- **AND** 提供正确的输入示例

#### Scenario: 支持多种分隔符
- **WHEN** 用户使用空格、逗号、短横线等分隔符（如 `I-V-vi-IV` 或 `I, V, vi, IV`）
- **THEN** 系统正确解析所有和弦
- **AND** 忽略分隔符类型差异

### Requirement: 走向库搜索与筛选

系统 SHALL 提供走向搜索与筛选功能，帮助用户快速找到目标走向。

#### Scenario: 按名称搜索
- **WHEN** 用户在搜索框输入关键词（如 "布鲁斯"）
- **THEN** 系统过滤并显示名称包含该关键词的走向
- **AND** 实时更新搜索结果

#### Scenario: 按标签筛选
- **WHEN** 用户选择某个标签（如 "jazz"）
- **THEN** 系统显示所有包含该标签的走向
- **AND** 支持多标签组合筛选

#### Scenario: 清除筛选条件
- **WHEN** 用户点击"清除筛选"或删除搜索关键词
- **THEN** 系统显示所有走向
- **AND** 恢复默认排序

### Requirement: 节奏型选择与播放

系统 SHALL 提供丰富的扫弦和分解节奏型，允许用户选择并应用到和弦走向练习中。

#### Scenario: 查看预置扫弦节奏型
- **WHEN** 用户打开节奏型选择器
- **AND** 选择"扫弦"模式
- **THEN** 系统显示至少 10 个预置扫弦节奏型
- **AND** 按风格分类（基础、流行、摇滚、布鲁斯、爵士）
- **AND** 每个节奏型包含名称、可视化展示（↓↑）、说明

#### Scenario: 查看预置分解节奏型
- **WHEN** 用户打开节奏型选择器
- **AND** 选择"分解"模式
- **THEN** 系统显示至少 8 个预置分解节奏型
- **AND** 包括经典分解、四拍分解、滚动分解、Travis picking 等
- **AND** 每个节奏型包含名称、弦号序列、说明

#### Scenario: 节奏型可视化展示
- **WHEN** 用户查看某个扫弦节奏型
- **THEN** 系统显示箭头符号（↓ 表示下扫，↑ 表示上扫）
- **AND** 重音位置用 `>` 或加粗标记
- **WHEN** 用户查看某个分解节奏型
- **THEN** 系统显示弦号序列（如 6-3-2-3-1-3-2-3）
- **AND** 标注时值信息（如八分音符、十六分音符）

#### Scenario: 节奏型预览试听
- **WHEN** 用户点击某个节奏型的"试听"按钮
- **THEN** 系统使用当前和弦播放该节奏型
- **AND** 按照选定的 BPM 播放
- **AND** 播放完整的一个小节或循环

#### Scenario: 选择节奏型应用到走向
- **WHEN** 用户选择某个扫弦或分解节奏型
- **THEN** 系统将该节奏型应用到当前走向
- **AND** 在练习播放时使用该节奏型
- **AND** 替换原有的简单扫弦或分解播放

#### Scenario: 节奏型偏好持久化
- **WHEN** 用户为某个走向选择节奏型
- **AND** 刷新页面或切换到其他走向后返回
- **THEN** 系统自动加载之前选择的节奏型
- **AND** 播放时使用该节奏型

#### Scenario: 不同走向的节奏型独立记忆
- **WHEN** 用户为走向 A 选择扫弦节奏型
- **AND** 为走向 B 选择分解节奏型
- **AND** 再次切换回走向 A
- **THEN** 系统加载走向 A 之前的扫弦节奏型
- **AND** 不受走向 B 的影响

### Requirement: 自定义节奏型

系统 SHALL 允许用户创建和保存自定义节奏型。

#### Scenario: 创建自定义扫弦节奏型
- **WHEN** 用户点击"添加自定义节奏型"
- **AND** 选择"扫弦"模式
- **AND** 输入 D/U 序列（如 `D DU UDU` 或 `D D>U UD<U`）
- **AND** 输入节奏型名称
- **THEN** 系统解析输入并生成节奏型
- **AND** 保存到本地存储
- **AND** 添加到节奏型列表

#### Scenario: 创建自定义分解节奏型
- **WHEN** 用户点击"添加自定义节奏型"
- **AND** 选择"分解"模式
- **AND** 输入弦号序列（如 `6 3 2 3 1 3 2 3` 或 `5-3-2-1`）
- **AND** 输入节奏型名称
- **THEN** 系统解析输入并生成节奏型
- **AND** 保存到本地存储
- **AND** 添加到节奏型列表

#### Scenario: 自定义节奏型输入验证
- **WHEN** 用户输入无效的扫弦序列（如包含非 D/U 字符）
- **THEN** 系统显示具体的错误提示
- **AND** 提供正确的输入示例
- **AND** 不允许保存无效的节奏型

#### Scenario: 编辑自定义节奏型
- **WHEN** 用户选择一个自定义节奏型
- **AND** 点击"编辑"
- **THEN** 系统打开编辑对话框
- **AND** 显示当前的节奏型定义
- **AND** 允许修改名称、序列、说明
- **AND** 保存后更新本地存储

#### Scenario: 删除自定义节奏型
- **WHEN** 用户选择一个自定义节奏型
- **AND** 点击"删除"
- **THEN** 系统显示确认对话框
- **AND** 确认后从本地存储删除
- **AND** 从节奏型列表移除

#### Scenario: 自定义节奏型与预置节奏型功能一致
- **WHEN** 用户选择一个自定义节奏型
- **THEN** 系统提供与预置节奏型相同的所有功能
- **AND** 包括：试听、应用到走向、可视化展示、偏好记忆

### Requirement: 节奏型音频播放

系统 SHALL 根据选定的节奏型准确播放和弦音频。

#### Scenario: 扫弦节奏型播放
- **WHEN** 系统使用扫弦节奏型播放和弦
- **THEN** 按照节奏型定义的上下扫顺序播放
- **AND** 下扫从低音弦到高音弦依次发声
- **AND** 上扫从高音弦到低音弦依次发声
- **AND** 音符间隔根据 BPM 和时值计算

#### Scenario: 分解节奏型播放
- **WHEN** 系统使用分解节奏型播放和弦
- **THEN** 按照节奏型定义的弦号序列依次发声
- **AND** 每个弦号对应的音符单独播放
- **AND** 音符间隔根据 BPM 和时值计算
- **AND** 无效弦号（如和弦中未使用的弦）跳过或静音

#### Scenario: 重音标记播放
- **WHEN** 节奏型中包含重音标记（如 `D>` 或 `>6`）
- **THEN** 系统以更高的音量播放该音符
- **AND** 音量增加约 20-30%
- **AND** 产生明显的重音效果

#### Scenario: 节奏型与 BPM 同步
- **WHEN** 用户调整 BPM 设置
- **THEN** 节奏型播放速度相应调整
- **AND** 保持节奏型的相对时值关系
- **AND** 与节拍器（如有）同步

### Requirement: 节奏型数据持久化

系统 SHALL 使用 LocalStorage 持久化节奏型偏好和自定义节奏型。

#### Scenario: 节奏型偏好存储
- **WHEN** 用户为某个走向选择节奏型
- **THEN** 系统将偏好保存到 LocalStorage key `rhythm-pattern-preferences`
- **AND** 数据格式为 `{ progressionId: { type: 'strum'|'arpeggio', patternId: string } }`

#### Scenario: 自定义节奏型存储
- **WHEN** 用户创建或编辑自定义节奏型
- **THEN** 系统将数据保存到 LocalStorage key `custom-rhythm-patterns`
- **AND** 数据格式为包含节奏型定义的 JSON 数组

#### Scenario: 节奏型数据恢复
- **WHEN** 用户刷新页面或重新打开应用
- **THEN** 系统自动加载所有自定义节奏型
- **AND** 恢复每个走向的节奏型偏好
- **AND** 数据解析失败时使用默认值，不阻塞应用

## MODIFIED Requirements

无修改的既有需求。

## REMOVED Requirements

无移除的需求。
